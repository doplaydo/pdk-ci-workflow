name: Push Compliance to PDKs

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  load-matrix:
    runs-on: ubuntu-latest
    outputs:
      pdks: ${{ steps.read.outputs.pdks }}
    steps:
      - uses: actions/checkout@v4

      - name: Read PDK registry
        id: read
        run: |
          echo "pdks=$(python3 -c "
          import yaml, json, sys
          data = yaml.safe_load(open('pdks.yml'))
          pdks = data.get('pdks', [])
          if not pdks:
              print('[]')
              sys.exit(0)
          print(json.dumps(pdks))
          ")" >> "$GITHUB_OUTPUT"

  push-compliance:
    needs: load-matrix
    if: needs.load-matrix.outputs.pdks != '[]'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 5
      matrix:
        pdk: ${{ fromJson(needs.load-matrix.outputs.pdks) }}
    steps:
      - name: Extract owner and repo
        id: parse
        run: |
          FULL="${{ matrix.pdk }}"
          echo "owner=${FULL%%/*}" >> "$GITHUB_OUTPUT"
          echo "repo=${FULL##*/}" >> "$GITHUB_OUTPUT"

      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.GH_APP_ID }}
          private-key: ${{ secrets.GH_APP_PRIVATE_KEY }}
          owner: ${{ steps.parse.outputs.owner }}
          repositories: ${{ steps.parse.outputs.repo }}

      - name: Checkout pdk-ci-workflow (for templates)
        uses: actions/checkout@v4
        with:
          path: source
          fetch-depth: 0

      - name: Determine version tag
        id: version
        working-directory: source
        run: |
          TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "main")
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "Using version: $TAG"

      - name: Clone target PDK
        run: |
          git clone \
            "https://x-access-token:${{ steps.app-token.outputs.token }}@github.com/${{ matrix.pdk }}.git" \
            target-pdk

      - name: Sync templates
        run: |
          VERSION="${{ steps.version.outputs.tag }}"
          cd source
          find templates -type f | while read -r f; do
            DEST="../target-pdk/${f#templates/}"
            mkdir -p "$(dirname "$DEST")"
            sed "s/{{VERSION}}/$VERSION/g" "$f" > "$DEST"
          done
          echo "Synced templates with version=$VERSION"

      - name: Install pre-commit and run hooks
        working-directory: target-pdk
        run: |
          pip install pre-commit
          # Run all hooks — auto-fix what we can, don't fail the workflow
          pre-commit run --all-files || true

      - name: Configure git
        working-directory: target-pdk
        run: |
          git config user.name "pdk-ci-workflow[bot]"
          git config user.email "pdk-ci-workflow[bot]@users.noreply.github.com"

      - name: Create PR if changes exist
        working-directory: target-pdk
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          BRANCH="pdk-ci-workflow/compliance-sync"
          VERSION="${{ steps.version.outputs.tag }}"

          git checkout -b "$BRANCH"
          git add -A

          if git diff --cached --quiet; then
            echo "No changes needed for ${{ matrix.pdk }}"
            exit 0
          fi

          git commit -m "chore: sync pdk-ci-workflow templates ($VERSION)"
          git push -u origin "$BRANCH" --force

          # Create PR or update existing one
          EXISTING=$(gh pr list --head "$BRANCH" --json number --jq '.[0].number' 2>/dev/null || echo "")
          if [ -n "$EXISTING" ]; then
            echo "PR #$EXISTING already exists for ${{ matrix.pdk }}, branch updated"
          else
            gh pr create \
              --title "chore: sync pdk-ci-workflow compliance templates ($VERSION)" \
              --body "$(cat <<'PREOF'
          ## Automated Compliance Sync

          This PR was automatically generated by [pdk-ci-workflow](https://github.com/doplaydo/pdk-ci-workflow) to sync:

          - GitHub Actions workflows (thin wrappers calling reusable workflows)
          - `.pre-commit-config.yaml` with all PDK compliance hooks
          - `dependabot.yml` configuration
          - `release-drafter.yml` configuration

          Pre-commit hooks were run automatically — any auto-fixable issues have been applied.

          Please review and merge to stay in compliance with the PDK template standards.
          PREOF
          )" \
              --base main
            echo "Created new compliance PR for ${{ matrix.pdk }}"
          fi
